# ГЛИБОКИЙ АНАЛІЗ СТРУКТУРИ: ВИЯВЛЕНІ УПУЩЕННЯ

## 1. КРИТИЧНІ УПУЩЕННЯ (блокують роботу)

### 1.1 Відсутні поля для гнучкості

| Таблиця | Що упущено | Навіщо потрібно |
|---------|------------|-----------------|
| **materials** | `is_sheet`, `is_round`, `is_tube`, `is_profile` | Визначення типу для правильних формул розрахунку |
| **materials** | `cutting_allowance` | Припуск на різання (мм) |
| **materials** | `waste_percent` | % технологічних відходів |
| **materials** | `min_order_qty` | Мінімальна партія замовлення |
| **materials** | `lead_time_days` | Термін поставки від постачальника |
| **item_routes** | `is_external` | Чи виконується на кооперації |
| **item_routes** | `subcontractor_id` | Який підрядник виконує |
| **items** | `is_critical` | Критична деталь (впливає на терміни) |
| **items** | `drawing_number` | Номер креслення |
| **items** | `revision` | Ревізія креслення |

### 1.2 Відсутні таблиці

| Таблиця | Призначення | Чому критично |
|---------|-------------|---------------|
| **material_prices_history** | Історія цін матеріалів | Аналіз динаміки, перерахунок старих калькуляцій |
| **currency_rates_history** | Історія курсів валют | Для калькуляцій на дату |
| **calculation_details** | Деталізація калькуляції | Зберігання розрахунків по кожній деталі |
| **document_templates** | Шаблони документів | Генерація КП, накладних тощо |
| **numbering_sequences** | Нумерація документів | Автоматичні номери КП-2024-001 |
| **settings** | Налаштування системи | Реквізити, % накладних, тощо |

### 1.3 Відсутні зв'язки

```
ПРОБЛЕМА: Калькуляція не зберігає "знімок" даних на момент розрахунку

calculations ──► materials (поточна ціна)
                 └── Якщо ціна зміниться - стара калькуляція покаже нову ціну!

РІШЕННЯ: Зберігати ціни НА МОМЕНТ калькуляції в calculation_details
```

---

## 2. ПРОБЛЕМИ З ІЄРАРХІЯМИ (ДЕРЕВАМИ)

### 2.1 Структура виробу

```
ПОТОЧНА СТРУКТУРА (спрощена):
items
├── parent_id → items.id

ПРОБЛЕМА:
- Немає обмеження глибини вкладеності
- Немає порядку сортування
- Немає типу зв'язку (входить в / замінює / альтернатива)

РІШЕННЯ:
items
├── parent_id → items.id
├── level (INT) - рівень вкладеності (0=виріб, 1=вузол, 2=підвузол, 3=деталь)
├── sort_order (INT) - порядок у специфікації
├── path (STRING) - повний шлях "1.2.3.4" для швидкого пошуку
└── relation_type (ENUM) - 'includes'/'replaces'/'alternative'
```

### 2.2 Групи матеріалів

```
ПОТОЧНА СТРУКТУРА:
material_groups
├── parent_id → material_groups.id

ПРОБЛЕМА:
- Немає перевірки циклічних посилань
- Немає кешованого шляху

РІШЕННЯ:
material_groups
├── parent_id
├── level (INT)
├── path (STRING) - "1/5/12" для швидкої вибірки всіх підгруп
├── full_name (STRING) - "Прокат / Листовий / Гарячекатаний"
└── is_leaf (BOOLEAN) - чи можна призначати матеріали
```

### 2.3 Організаційна структура

```
ПОТРІБНО ДОДАТИ:
departments
├── parent_id → departments.id (для ієрархії Цех → Дільниця → Бригада)
├── level
├── path
└── type (ENUM) - 'workshop'/'section'/'team'
```

---

## 3. ВІДСУТНЯ БІЗНЕС-ЛОГІКА

### 3.1 Формули розрахунків (потрібно зберігати)

```
ПОТРІБНА ТАБЛИЦЯ: calculation_formulas

| Код | Формула | Опис |
|-----|---------|------|
| WEIGHT_SHEET | thickness * width * length * density / 1000000000 | Вага листа, кг |
| WEIGHT_ROUND | PI * (diameter/2)^2 * length * density / 1000000000 | Вага круга, кг |
| WEIGHT_TUBE | PI * ((OD/2)^2 - (ID/2)^2) * length * density / 1000000000 | Вага труби, кг |
| AREA_SHEET | width * length / 1000000 | Площа листа, м² |
| LABOR_COST | (setup_time + piece_time * qty * batch_coef) / 60 * hourly_rate | Вартість роботи |
```

### 3.2 Правила валідації

```
ПОТРІБНА ТАБЛИЦЯ: validation_rules

| Поле | Правило | Повідомлення |
|------|---------|--------------|
| materials.thickness | > 0 AND <= 200 | Товщина від 0.1 до 200 мм |
| materials.price | > 0 | Ціна має бути більше 0 |
| items.quantity | >= 1 | Кількість мінімум 1 |
| time_norms.piece_time | > 0 | Штучний час має бути більше 0 |
```

### 3.3 Статуси та переходи

```
ПОТРІБНА ТАБЛИЦЯ: status_transitions

Проект (project):
draft → design → review → approved → production → completed
                  ↓
               rejected → draft (повернення на доопрацювання)

КП (quotation):
draft → sent → negotiation → approved → contract
                    ↓
                 rejected

Виробниче замовлення:
planned → materials_reserved → in_production → quality_check → completed
              ↓                     ↓
           on_hold              on_hold (брак, очікування)
```

---

## 4. УПУЩЕННЯ В ДОВІДНИКАХ

### 4.1 Одиниці виміру - потрібні конвертації

```
ПОТРІБНА ТАБЛИЦЯ: unit_conversions

| Від | До | Коефіцієнт | Приклад |
|-----|-----|-----------|---------|
| т | кг | 1000 | 1 т = 1000 кг |
| м | мм | 1000 | 1 м = 1000 мм |
| м² | см² | 10000 | 1 м² = 10000 см² |
| год | хв | 60 | 1 год = 60 хв |
| л | мл | 1000 | 1 л = 1000 мл |
```

### 4.2 Матеріали - потрібні додаткові властивості

```
ПОТРІБНА ТАБЛИЦЯ: material_properties

| Властивість | Тип | Для яких матеріалів |
|-------------|-----|---------------------|
| yield_strength | Decimal | Межа текучості, МПа |
| tensile_strength | Decimal | Межа міцності, МПа |
| elongation | Decimal | Відносне подовження, % |
| hardness | String | Твердість (HB, HRC) |
| weldability | Enum | good/satisfactory/limited/not_recommended |
| machinability | Decimal | Коеф. оброблюваності відн. Ст45 |
| corrosion_resistance | Enum | none/low/medium/high |
```

### 4.3 Обладнання - потрібні режими

```
ПОТРІБНА ТАБЛИЦЯ: equipment_modes

Для токарного верстата:
| Параметр | Мін | Макс | Одиниця |
|----------|-----|------|---------|
| spindle_speed | 12 | 2000 | об/хв |
| feed_rate | 0.05 | 2.8 | мм/об |
| cutting_depth | 0.5 | 12 | мм |

Для зварювання MIG:
| Параметр | Мін | Макс | Одиниця |
|----------|-----|------|---------|
| current | 50 | 500 | А |
| voltage | 16 | 40 | В |
| wire_speed | 2 | 20 | м/хв |
| gas_flow | 8 | 25 | л/хв |
```

---

## 5. УПУЩЕННЯ В ДОКУМЕНТООБІГУ

### 5.1 Версіонування документів

```
ПОТРІБНА ТАБЛИЦЯ: document_versions

| Документ | Версія | Дата | Автор | Зміни | Файл |
|----------|--------|------|-------|-------|------|
| КП-2024-001 | 1 | 01.01 | Іванов | Створено | file1.pdf |
| КП-2024-001 | 2 | 03.01 | Іванов | Змінено ціну | file2.pdf |
| КП-2024-001 | 3 | 05.01 | Петров | Додано позицію | file3.pdf |
```

### 5.2 Підписи/погодження

```
ПОТРІБНА ТАБЛИЦЯ: approvals

| Документ | Етап | Роль | Користувач | Статус | Дата | Коментар |
|----------|------|------|------------|--------|------|----------|
| ТП-001 | 1 | Технолог | Сидоров | approved | 01.01 | |
| ТП-001 | 2 | Н.контроль | Козлов | approved | 02.01 | |
| ТП-001 | 3 | Гол.технолог | Мельник | rejected | 03.01 | Уточнити норми |
```

### 5.3 Зв'язки між документами

```
ПОТРІБНА ТАБЛИЦЯ: document_relations

| Документ 1 | Тип зв'язку | Документ 2 |
|------------|-------------|------------|
| Запит-001 | породжує | КП-2024-001 |
| КП-2024-001 | породжує | Договір-123 |
| Договір-123 | породжує | ВЗ-001 (виробниче замовлення) |
| ВЗ-001 | породжує | МЛ-001 (маршрутний лист) |
| МЛ-001 | породжує | Накладна-456 |
```

---

## 6. УПУЩЕННЯ В ОБЛІКУ

### 6.1 Партії матеріалів

```
ПОТРІБНА ТАБЛИЦЯ: material_batches (партії/плавки)

| Матеріал | Партія | Постачальник | Сертифікат | Дата | Кількість | Залишок |
|----------|--------|--------------|------------|------|-----------|---------|
| Лист 4мм | П-2024-001 | Метінвест | Серт-123 | 01.01 | 50 шт | 35 шт |

Навіщо:
- Відстеження сертифікатів якості
- FIFO списання
- Простежуваність (в яких виробах використано)
```

### 6.2 Серійні номери виробів

```
ПОТРІБНА ТАБЛИЦЯ: serial_numbers

| Виріб | Серійний № | Виробн.замовлення | Дата випуску | Клієнт | Гарантія до |
|-------|------------|-------------------|--------------|--------|-------------|
| Насос НШ-10 | SN-2024-0001 | ВЗ-001 | 15.01.2024 | ТОВ "Агро" | 15.01.2025 |

Навіщо:
- Гарантійне обслуговування
- Рекламації
- Історія виробу
```

### 6.3 Облік робочого часу

```
ПОТРІБНА ТАБЛИЦЯ: time_entries (табель/виробіток)

| Дата | Працівник | Замовлення | Операція | Кількість | Час факт | Час норма |
|------|-----------|------------|----------|-----------|----------|-----------|
| 15.01 | Коваленко | ВЗ-001 | Токарна | 10 шт | 4.5 год | 4.0 год |

Навіщо:
- Нарахування зарплати
- Аналіз продуктивності
- Уточнення норм
```

---

## 7. УПУЩЕННЯ В АНАЛІТИЦІ

### 7.1 Кеш агрегованих даних

```
ПОТРІБНІ ТАБЛИЦІ для швидких звітів:

daily_production_stats - щоденна статистика
├── date
├── department_id
├── planned_hours
├── actual_hours
├── completed_orders
├── defect_count

monthly_sales_stats - місячні продажі
├── year_month
├── client_id
├── orders_count
├── total_amount
├── avg_margin
```

### 7.2 Планові показники

```
ПОТРІБНА ТАБЛИЦЯ: targets (планові показники)

| Рік | Місяць | Показник | План | Факт |
|-----|--------|----------|------|------|
| 2024 | 01 | Виручка | 1000000 | 950000 |
| 2024 | 01 | Маржа % | 25 | 23 |
| 2024 | 01 | Брак % | 2 | 1.5 |
```

---

## 8. ТЕХНІЧНІ УПУЩЕННЯ

### 8.1 Soft Delete

```
ВСІ основні таблиці повинні мати:
├── is_deleted (BOOLEAN) - замість фізичного видалення
├── deleted_at (DATETIME)
├── deleted_by (UUID)

Навіщо: відновлення помилково видалених даних
```

### 8.2 Мультимовність

```
ПОТРІБНА ТАБЛИЦЯ: translations (якщо буде експорт)

| Таблиця | Поле | Мова | Значення |
|---------|------|------|----------|
| materials | name | uk | Лист г/к 4мм |
| materials | name | en | Hot-rolled sheet 4mm |
| materials | name | de | Warmgewalztes Blech 4mm |
```

### 8.3 Файли/вкладення

```
ПОТРІБНА ТАБЛИЦЯ: attachments

| ID | Таблиця | Запис ID | Тип файлу | Назва | Розмір | URL |
|----|---------|----------|-----------|-------|--------|-----|
| 1 | projects | PRJ-001 | drawing | Креслення.pdf | 2.5MB | /files/... |
| 2 | projects | PRJ-001 | 3d_model | Модель.step | 15MB | /files/... |
| 3 | quotations | КП-001 | document | КП підписана.pdf | 500KB | /files/... |
```

---

## 9. РЕЗЮМЕ: ЩО ПОТРІБНО ДОДАТИ

### Нові таблиці (17 шт):
1. `material_prices_history` - історія цін
2. `currency_rates_history` - історія курсів
3. `calculation_details` - деталі калькуляції
4. `calculation_formulas` - формули
5. `document_templates` - шаблони
6. `numbering_sequences` - нумерація
7. `settings` - налаштування
8. `unit_conversions` - конвертація одиниць
9. `material_properties` - властивості матеріалів
10. `equipment_modes` - режими обладнання
11. `document_versions` - версії документів
12. `approvals` - погодження
13. `document_relations` - зв'язки документів
14. `material_batches` - партії матеріалів
15. `serial_numbers` - серійні номери
16. `time_entries` - облік часу
17. `attachments` - файли

### Нові поля в існуючих таблицях:
- `items`: level, sort_order, path, relation_type, is_critical, drawing_number, revision
- `materials`: is_sheet, is_round, cutting_allowance, waste_percent, min_order_qty, lead_time_days
- `material_groups`: level, path, full_name, is_leaf
- `departments`: parent_id, level, path, type
- `item_routes`: is_external, subcontractor_id
- Всі таблиці: is_deleted, deleted_at, deleted_by

---

## 10. ПОРЯДОК СТВОРЕННЯ (з урахуванням залежностей)

```
РІВЕНЬ 0 (без залежностей):
├── settings
├── numbering_sequences
├── calculation_formulas
├── document_templates
└── unit_conversions (тільки базові одиниці)

РІВЕНЬ 1 (залежать від рівня 0):
├── units (з конвертаціями)
├── currencies
├── currency_rates_history
├── countries
├── vat_rates
└── roles

РІВЕНЬ 2 (залежать від рівня 1):
├── users
├── material_grades
├── material_groups (ієрархія)
├── departments (ієрархія)
└── warehouses

РІВЕНЬ 3 (залежать від рівня 2):
├── materials
├── material_properties
├── material_prices_history
├── equipment
├── equipment_modes
├── operations
└── contractors

РІВЕНЬ 4 (залежать від рівня 3):
├── time_norms
├── consumables
├── operation_consumables
├── operation_equipment
├── batch_coefficients
└── overhead_rates

РІВЕНЬ 5 (бізнес-сутності):
├── projects
├── items (ієрархія)
├── item_routes
├── calculations
├── calculation_details
└── attachments

РІВЕНЬ 6 (документообіг):
├── inquiries
├── quotations
├── contracts
├── invoices
├── purchase_orders
├── production_orders
└── document_versions, approvals, document_relations

РІВЕНЬ 7 (операційний облік):
├── stock_movements
├── material_batches
├── work_orders
├── time_entries
├── quality_records
└── serial_numbers
```
