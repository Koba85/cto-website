# СХЕМА ЗАЛЕЖНОСТЕЙ МІЖ ТАБЛИЦЯМИ

## ВІЗУАЛЬНА КАРТА ЗАЛЕЖНОСТЕЙ

```
╔═══════════════════════════════════════════════════════════════════════════════════════════╗
║                                    РІВЕНЬ 0: ЯДРО СИСТЕМИ                                 ║
║                                    (без залежностей)                                      ║
╠═══════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                           ║
║  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     ║
║  │  settings   │  │ numbering_  │  │ calculation │  │  document_  │  │    units    │     ║
║  │             │  │ sequences   │  │  _formulas  │  │  templates  │  │             │     ║
║  │ Налаштуван. │  │ Нумерація   │  │ Формули     │  │ Шаблони     │  │ Од. виміру  │     ║
║  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  └──────┬──────┘     ║
║                                                                             │            ║
╠═════════════════════════════════════════════════════════════════════════════╪════════════╣
║                                    РІВЕНЬ 1: БАЗОВІ ДОВІДНИКИ                │            ║
╠═════════════════════════════════════════════════════════════════════════════╪════════════╣
║                                                                             │            ║
║  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │            ║
║  │ currencies  │  │  countries  │  │  vat_rates  │  │   roles     │        │            ║
║  │             │  │             │  │             │  │             │        │            ║
║  │ Валюти      │  │ Країни      │  │ Ставки ПДВ  │  │ Ролі        │        │            ║
║  └──────┬──────┘  └─────────────┘  └─────────────┘  └──────┬──────┘        │            ║
║         │                                                  │               │            ║
║         ▼                                                  │               │            ║
║  ┌─────────────┐                            ┌─────────────┐│  ┌────────────┴──────────┐ ║
║  │ currency_   │                            │             ││  │   unit_conversions    │ ║
║  │ rates_hist  │                            │             ▼▼  │                       │ ║
║  │ Історія     │                            │  ┌─────────────┐│ Конвертація одиниць   │ ║
║  │ курсів      │                            │  │   users     ││                       │ ║
║  └─────────────┘                            │  │             ││                       │ ║
║                                             │  │ Користувачі ││                       │ ║
║                                             │  └──────┬──────┘│                       │ ║
║                                             │         │       └───────────────────────┘ ║
╠═════════════════════════════════════════════╪═════════╪═══════════════════════════════════╣
║                      РІВЕНЬ 2: СТРУКТУРНІ ДОВІДНИКИ   │                                   ║
╠═════════════════════════════════════════════╪═════════╪═══════════════════════════════════╣
║                                             │         │                                   ║
║  ┌─────────────────────────┐               │         │    ┌─────────────────────────┐   ║
║  │    material_grades      │               │         │    │    material_groups      │   ║
║  │                         │               │         │    │        (ДЕРЕВО)         │   ║
║  │ Марки матеріалів        │               │         │    │                         │   ║
║  │ (Ст3кп, 09Г2С, AISI304) │               │         │    │ Групи матеріалів        │   ║
║  └───────────┬─────────────┘               │         │    │ (Листовий→Г/к→Ст3)      │   ║
║              │                             │         │    └───────────┬─────────────┘   ║
║              │    ┌────────────────────────┘         │                │                 ║
║              │    │                                  │                │                 ║
║              │    │  ┌─────────────────────────┐     │    ┌───────────┴─────────────┐   ║
║              │    │  │     departments         │     │    │      warehouses         │   ║
║              │    │  │        (ДЕРЕВО)         │     │    │                         │   ║
║              │    │  │                         │◄────┘    │ Склади                  │   ║
║              │    │  │ Цех→Дільниця→Бригада    │          │                         │   ║
║              │    │  └───────────┬─────────────┘          └─────────────────────────┘   ║
║              │    │              │                                                      ║
╠══════════════╪════╪══════════════╪══════════════════════════════════════════════════════╣
║              │    │   РІВЕНЬ 3: ОСНОВНІ ДОВІДНИКИ                                       ║
╠══════════════╪════╪══════════════╪══════════════════════════════════════════════════════╣
║              │    │              │                                                      ║
║              ▼    ▼              ▼                                                      ║
║  ┌───────────────────────────────────────────┐    ┌─────────────────────────────────┐  ║
║  │              materials                     │    │         equipment               │  ║
║  │                                           │    │                                 │  ║
║  │ Сортамент матеріалів                      │    │ Обладнання                      │  ║
║  │ (Лист 4×1250×2500, Круг 20, Труба 57×3.5) │    │ (Гільйотина, Токарний, MIG-500) │  ║
║  └─────────────────┬─────────────────────────┘    └────────────────┬────────────────┘  ║
║                    │                                               │                   ║
║         ┌──────────┼──────────┐                         ┌──────────┼──────────┐       ║
║         ▼          ▼          ▼                         ▼          ▼          ▼       ║
║  ┌───────────┐┌───────────┐┌───────────┐        ┌───────────┐┌───────────┐           ║
║  │ material_ ││ material_ ││ material_ │        │ equipment_││ equipment_│           ║
║  │ properties││ prices_   ││ batches   │        │ modes     ││ operations│           ║
║  │           ││ history   ││           │        │           ││           │           ║
║  │ Властивос.││ Історія   ││ Партії    │        │ Режими    ││ Зв'язок з │           ║
║  │ матеріалу ││ цін       ││ /плавки   │        │ роботи    ││ операціями│           ║
║  └───────────┘└───────────┘└───────────┘        └───────────┘└─────┬─────┘           ║
║                                                                    │                  ║
║  ┌─────────────────────────────────────────────────────────────────┼──────────────┐   ║
║  │                        operations                               │              │   ║
║  │                                                                 │              │   ║
║  │ Операції (005-Заготівельна, 015-Токарна, 035-Зварювання)       │              │   ║
║  └─────────────────────────────────┬───────────────────────────────┘              │   ║
║                                    │                                              │   ║
║  ┌─────────────────────────────────┼──────────────────────────────────────────────┼───╣
║  │                    РІВЕНЬ 4: НОРМАТИВИ                                         │   ║
║  ├─────────────────────────────────┼──────────────────────────────────────────────┼───╣
║  │                                 │                                              │   ║
║  │                                 ▼                                              │   ║
║  │  ┌─────────────────────────────────────────────────────────────────────────┐  │   ║
║  │  │                         time_norms                                      │  │   ║
║  │  │                                                                         │  │   ║
║  │  │ Норми часу (Операція + Обладнання + Параметри → Тпз + Тшт)             │  │   ║
║  │  └─────────────────────────────────────────────────────────────────────────┘  │   ║
║  │                                                                               │   ║
║  │  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐         │   ║
║  │  │   consumables     │  │ operation_        │  │ batch_            │         │   ║
║  │  │                   │  │ consumables       │  │ coefficients      │         │   ║
║  │  │ Розхідники        │─▶│ Витрати на оп.    │  │ Коеф. партійності │         │   ║
║  │  │ (Дріт, газ, СОЖ)  │  │                   │  │                   │         │   ║
║  │  └───────────────────┘  └───────────────────┘  └───────────────────┘         │   ║
║  │                                                                               │   ║
║  │  ┌───────────────────┐                                                        │   ║
║  │  │  overhead_rates   │                                                        │   ║
║  │  │                   │                                                        │   ║
║  │  │ Накладні витрати  │                                                        │   ║
║  │  │ (ЗВВ, адмін, збут)│                                                        │   ║
║  │  └───────────────────┘                                                        │   ║
║  └───────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                       ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                    contractors                                                  │ ║
║  │                                                                                 │ ║
║  │ Контрагенти: Клієнти + Постачальники + Підрядники                              │ ║
║  └────────────────────────────────────┬────────────────────────────────────────────┘ ║
║                                       │                                              ║
╠═══════════════════════════════════════╪══════════════════════════════════════════════╣
║                    РІВЕНЬ 5: БІЗНЕС-СУТНОСТІ (ПРОЕКТИ)                                ║
╠═══════════════════════════════════════╪══════════════════════════════════════════════╣
║                                       │                                              ║
║                                       ▼                                              ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                              projects                                           │ ║
║  │                                                                                 │ ║
║  │ Проекти/Вироби (Клієнт, Менеджер, Конструктор, Статус, Версія)                 │ ║
║  └────────────────────────────────────┬────────────────────────────────────────────┘ ║
║                                       │                                              ║
║                                       ▼                                              ║
║  ┌─────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                          items (ДЕРЕВО)                                         │ ║
║  │                                                                                 │ ║
║  │ Структура виробу: Виріб → Вузли → Деталі                                       │ ║
║  │ (parent_id, level, path, sort_order, quantity, material, розміри)              │ ║
║  └───────────────────────────────┬─────────────────────────────────────────────────┘ ║
║                                  │                                                   ║
║                   ┌──────────────┼──────────────┐                                    ║
║                   ▼              ▼              ▼                                    ║
║  ┌────────────────────┐ ┌────────────────┐ ┌────────────────────┐                   ║
║  │    item_routes     │ │  attachments   │ │   calculations     │                   ║
║  │                    │ │                │ │                    │                   ║
║  │ Маршрут виготовлен.│ │ Файли/креслен. │ │ Калькуляції        │                   ║
║  │ (операції, норми)  │ │                │ │                    │                   ║
║  └─────────┬──────────┘ └────────────────┘ └─────────┬──────────┘                   ║
║            │                                         │                              ║
║            │                                         ▼                              ║
║            │                            ┌────────────────────────┐                  ║
║            │                            │  calculation_details   │                  ║
║            │                            │                        │                  ║
║            │                            │ Деталізація калькуляції│                  ║
║            │                            │ (знімок цін на момент) │                  ║
║            │                            └────────────────────────┘                  ║
║            │                                                                        ║
╠════════════╪════════════════════════════════════════════════════════════════════════╣
║            │         РІВЕНЬ 6: ДОКУМЕНТООБІГ                                        ║
╠════════════╪════════════════════════════════════════════════════════════════════════╣
║            │                                                                        ║
║  ┌─────────┴─────────────────────────────────────────────────────────────────────┐ ║
║  │                                                                               │ ║
║  │  inquiries ──► quotations ──► contracts ──► production_orders                │ ║
║  │  Запити       КП             Договори       Виробничі замовлення             │ ║
║  │                    │              │                   │                       │ ║
║  │                    ▼              ▼                   ▼                       │ ║
║  │               invoices      purchase_orders     work_orders                  │ ║
║  │               Рахунки       Замовлення пост.    Наряди                       │ ║
║  │                                                                               │ ║
║  └───────────────────────────────────────────────────────────────────────────────┘ ║
║                                                                                     ║
║  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                     ║
║  │ document_       │  │   approvals     │  │ document_       │                     ║
║  │ versions        │  │                 │  │ relations       │                     ║
║  │ Версії докум.   │  │ Погодження      │  │ Зв'язки докум.  │                     ║
║  └─────────────────┘  └─────────────────┘  └─────────────────┘                     ║
║                                                                                     ║
╠═════════════════════════════════════════════════════════════════════════════════════╣
║                    РІВЕНЬ 7: ОПЕРАЦІЙНИЙ ОБЛІК                                      ║
╠═════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                     ║
║  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐║
║  │ stock_movements │  │  time_entries   │  │ quality_records │  │ serial_numbers  │║
║  │                 │  │                 │  │                 │  │                 │║
║  │ Рух по складу   │  │ Облік часу      │  │ Записи якості   │  │ Серійні номери  │║
║  │ (прихід/розхід) │  │ (виробіток)     │  │ (контроль,брак) │  │                 │║
║  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘║
║                                                                                     ║
╚═════════════════════════════════════════════════════════════════════════════════════╝
```

---

## ДЕТАЛЬНА КАРТА ЗВ'ЯЗКІВ

### ДЕРЕВО 1: Структура виробу

```
projects (Проект)
    │
    ├── 1:N ──► items (Позиції специфікації)
    │               │
    │               ├── self-reference ──► parent_id (ієрархія)
    │               │
    │               │   РІВНІ:
    │               │   level=0: Виріб (корінь)
    │               │   level=1: Вузол/Складальна одиниця
    │               │   level=2: Підвузол
    │               │   level=3: Деталь
    │               │
    │               ├── N:1 ──► materials (матеріал деталі)
    │               │
    │               ├── 1:N ──► item_routes (маршрут виготовлення)
    │               │               │
    │               │               ├── N:1 ──► operations
    │               │               ├── N:1 ──► equipment
    │               │               └── N:1 ──► contractors (якщо кооперація)
    │               │
    │               └── 1:N ──► attachments (креслення, моделі)
    │
    ├── 1:N ──► calculations (калькуляції)
    │               │
    │               └── 1:N ──► calculation_details (деталізація)
    │
    └── 1:N ──► document_versions (версії КД)
```

### ДЕРЕВО 2: Матеріали

```
material_groups (Групи - ДЕРЕВО)
    │
    ├── self-reference ──► parent_id
    │
    │   ПРИКЛАД ІЄРАРХІЇ:
    │   ├── Прокат (level=0)
    │   │   ├── Листовий (level=1)
    │   │   │   ├── Гарячекатаний (level=2)
    │   │   │   ├── Холоднокатаний (level=2)
    │   │   │   └── Нержавіючий (level=2)
    │   │   ├── Сортовий (level=1)
    │   │   │   ├── Круг (level=2)
    │   │   │   ├── Квадрат (level=2)
    │   │   │   └── Шестигранник (level=2)
    │   │   └── Профільний (level=1)
    │   │       ├── Труба кругла (level=2)
    │   │       ├── Труба профільна (level=2)
    │   │       ├── Кутик (level=2)
    │   │       └── Швелер (level=2)
    │   └── Кріплення (level=0)
    │       ├── Болти (level=1)
    │       ├── Гайки (level=1)
    │       └── Шайби (level=1)
    │
    └── 1:N ──► materials (конкретні позиції)
                    │
                    ├── N:1 ──► material_grades (марка)
                    │               │
                    │               └── 1:N ──► material_properties
                    │
                    ├── N:1 ──► units (одиниця виміру)
                    │
                    ├── N:1 ──► currencies (валюта ціни)
                    │
                    ├── N:1 ──► contractors (постачальник)
                    │
                    ├── 1:N ──► material_prices_history
                    │
                    └── 1:N ──► material_batches (партії)
```

### ДЕРЕВО 3: Організаційна структура

```
departments (Підрозділи - ДЕРЕВО)
    │
    ├── self-reference ──► parent_id
    │
    │   ПРИКЛАД ІЄРАРХІЇ:
    │   ├── Виробництво (level=0, type=division)
    │   │   ├── Механічний цех (level=1, type=workshop)
    │   │   │   ├── Токарна дільниця (level=2, type=section)
    │   │   │   └── Фрезерна дільниця (level=2, type=section)
    │   │   ├── Зварювальний цех (level=1, type=workshop)
    │   │   │   └── Зварювальна дільниця (level=2, type=section)
    │   │   └── Складальний цех (level=1, type=workshop)
    │   └── Адміністрація (level=0, type=division)
    │       ├── Конструкторський відділ (level=1, type=department)
    │       └── Технологічний відділ (level=1, type=department)
    │
    ├── N:1 ──► users (керівник)
    │
    └── 1:N ──► equipment (обладнання дільниці)
                    │
                    ├── 1:N ──► equipment_modes (режими)
                    │
                    └── N:M ──► operations (через equipment_operations)
```

### ДЕРЕВО 4: Документообіг

```
inquiries (Запити)
    │
    └── 1:N ──► quotations (КП)
                    │
                    ├── 1:N ──► quotation_items (позиції КП)
                    │
                    ├── 1:N ──► document_versions (версії)
                    │
                    └── 1:1 ──► contracts (договір)
                                    │
                                    ├── 1:N ──► contract_specifications
                                    │
                                    ├── 1:N ──► invoices (рахунки)
                                    │               │
                                    │               └── 1:N ──► payments (оплати)
                                    │
                                    └── 1:N ──► production_orders (ВЗ)
                                                    │
                                                    ├── 1:N ──► work_orders (наряди)
                                                    │               │
                                                    │               └── 1:N ──► time_entries
                                                    │
                                                    ├── 1:N ──► stock_movements
                                                    │
                                                    ├── 1:N ──► quality_records
                                                    │
                                                    └── 1:N ──► shipments (відвантаження)
                                                                    │
                                                                    └── 1:N ──► serial_numbers
```

---

## МАТРИЦЯ ЗАЛЕЖНОСТЕЙ

```
                    ┌─────────────────────────────────────────────────────────────────┐
                    │                      ЗАЛЕЖИТЬ ВІД                               │
                    ├────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┤
                    │unit│curr│role│m_gr│m_gd│dept│ware│equp│oper│cont│proj│item│calc│
┌───────────────────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
│ units             │    │    │    │    │    │    │    │    │    │    │    │    │    │
│ currencies        │    │    │    │    │    │    │    │    │    │    │    │    │    │
│ roles             │    │    │    │    │    │    │    │    │    │    │    │    │    │
│ users             │    │    │ ●  │    │    │    │    │    │    │    │    │    │    │
│ material_groups   │    │    │    │ ◐  │    │    │    │    │    │    │    │    │    │
│ material_grades   │    │    │    │    │    │    │    │    │    │    │    │    │    │
│ materials         │ ●  │ ●  │    │ ●  │ ●  │    │    │    │    │ ○  │    │    │    │
│ departments       │    │    │    │    │    │ ◐  │    │    │    │    │    │    │    │
│ warehouses        │    │    │    │    │    │ ●  │    │    │    │    │    │    │    │
│ equipment         │    │    │    │    │    │ ●  │    │    │    │    │    │    │    │
│ operations        │    │    │    │    │    │    │    │    │    │    │    │    │    │
│ time_norms        │    │    │    │ ○  │    │    │    │ ●  │ ●  │    │    │    │    │
│ contractors       │    │ ●  │    │    │    │    │    │    │    │    │    │    │    │
│ projects          │    │    │    │    │    │    │    │    │    │ ●  │    │    │    │
│ items             │    │    │    │    │    │    │    │    │    │    │ ●  │ ◐  │    │
│ item_routes       │    │    │    │    │    │    │    │ ●  │ ●  │ ○  │    │ ●  │    │
│ calculations      │    │ ●  │    │    │    │    │    │    │    │    │ ●  │    │    │
│ calc_details      │    │    │    │    │    │    │    │    │    │    │    │ ●  │ ●  │
│ quotations        │    │ ●  │    │    │    │    │    │    │    │ ●  │ ●  │    │ ●  │
│ contracts         │    │ ●  │    │    │    │    │    │    │    │ ●  │    │    │    │
│ production_orders │    │    │    │    │    │    │    │    │    │ ●  │ ●  │    │    │
│ stock_movements   │ ●  │    │    │    │    │    │ ●  │    │    │    │    │    │    │
└───────────────────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘

Легенда:
● - обов'язкова залежність (NOT NULL)
○ - опціональна залежність (NULL allowed)
◐ - self-reference (ієрархія)
```

---

## ПОРЯДОК СТВОРЕННЯ ТАБЛИЦЬ

```sql
-- ЕТАП 1: Незалежні таблиці
CREATE TABLE settings;
CREATE TABLE numbering_sequences;
CREATE TABLE calculation_formulas;
CREATE TABLE document_templates;
CREATE TABLE units;
CREATE TABLE currencies;
CREATE TABLE countries;
CREATE TABLE vat_rates;
CREATE TABLE roles;

-- ЕТАП 2: Прості залежності
CREATE TABLE unit_conversions;      -- → units
CREATE TABLE currency_rates_history; -- → currencies
CREATE TABLE users;                 -- → roles

-- ЕТАП 3: Ієрархічні довідники
CREATE TABLE material_groups;       -- self-ref
CREATE TABLE material_grades;
CREATE TABLE departments;           -- self-ref

-- ЕТАП 4: Основні довідники
CREATE TABLE warehouses;            -- → departments
CREATE TABLE materials;             -- → groups, grades, units, currencies
CREATE TABLE material_properties;   -- → grades
CREATE TABLE material_prices_history; -- → materials
CREATE TABLE equipment;             -- → departments
CREATE TABLE equipment_modes;       -- → equipment
CREATE TABLE operations;
CREATE TABLE operation_equipment;   -- → operations, equipment
CREATE TABLE contractors;           -- → currencies, countries

-- ЕТАП 5: Нормативи
CREATE TABLE time_norms;            -- → operations, equipment, material_groups
CREATE TABLE consumables;           -- → units
CREATE TABLE operation_consumables; -- → operations, consumables
CREATE TABLE batch_coefficients;
CREATE TABLE overhead_rates;

-- ЕТАП 6: Проекти
CREATE TABLE projects;              -- → contractors (client), users
CREATE TABLE items;                 -- → projects, materials, self-ref
CREATE TABLE item_routes;           -- → items, operations, equipment, contractors
CREATE TABLE attachments;           -- → polymorphic

-- ЕТАП 7: Калькуляції
CREATE TABLE calculations;          -- → projects, currencies
CREATE TABLE calculation_details;   -- → calculations, items

-- ЕТАП 8: Документообіг
CREATE TABLE inquiries;             -- → contractors, users
CREATE TABLE quotations;            -- → inquiries, projects, calculations, contractors
CREATE TABLE contracts;             -- → quotations, contractors
CREATE TABLE invoices;              -- → contracts
CREATE TABLE payments;              -- → invoices
CREATE TABLE purchase_orders;       -- → contractors
CREATE TABLE production_orders;     -- → contracts, projects

-- ЕТАП 9: Операційний облік
CREATE TABLE material_batches;      -- → materials, contractors
CREATE TABLE stock_movements;       -- → materials, warehouses, batches
CREATE TABLE work_orders;           -- → production_orders, items, operations
CREATE TABLE time_entries;          -- → work_orders, users
CREATE TABLE quality_records;       -- → production_orders, items
CREATE TABLE serial_numbers;        -- → production_orders, items
CREATE TABLE shipments;             -- → contracts

-- ЕТАП 10: Службові
CREATE TABLE document_versions;     -- polymorphic
CREATE TABLE approvals;             -- polymorphic
CREATE TABLE document_relations;
CREATE TABLE audit_log;
```
