# Перевірка ієрархічних структур (дерева)

## 1. Структура підрозділів (departments)

```
ВИРОБНИЦТВО (DEP01)
├── Заготівельна дільниця (DEP02)
│   ├── level: 1
│   ├── path: DEP01/DEP02
│   └── sort_order: 1
├── Механічна дільниця (DEP03)
│   ├── level: 1
│   ├── path: DEP01/DEP03
│   └── sort_order: 2
├── Зварювальна дільниця (DEP04)
│   ├── level: 1
│   ├── path: DEP01/DEP04
│   └── sort_order: 3
├── Слюсарна дільниця (DEP05)
│   ├── level: 1
│   ├── path: DEP01/DEP05
│   └── sort_order: 4
├── Складальна дільниця (DEP06)
│   ├── level: 1
│   ├── path: DEP01/DEP06
│   └── sort_order: 5
├── Фарбувальна дільниця (DEP07)
│   ├── level: 1
│   ├── path: DEP01/DEP07
│   └── sort_order: 6
└── ВТК (DEP08)
    ├── level: 1
    ├── path: DEP01/DEP08
    └── sort_order: 7

АДМІНІСТРАЦІЯ (DEP09)
├── level: 0
└── path: DEP09

СКЛАД (DEP10)
├── level: 0
└── path: DEP10
```

### SQL-запити для дерева підрозділів:

```sql
-- Отримати всі підрозділи виробництва
SELECT * FROM departments
WHERE path LIKE 'DEP01/%' OR id = 'DEP01'
ORDER BY level, sort_order;

-- Отримати прямих нащадків
SELECT * FROM departments
WHERE parent_id = 'DEP01'
ORDER BY sort_order;

-- Отримати повний шлях до підрозділу
SELECT * FROM departments
WHERE id IN (SELECT unnest(string_to_array(path, '/')))
ORDER BY level;
```

---

## 2. Структура груп матеріалів (material_groups)

```
ПРОКАТ (MG01)
├── Листовий прокат (MG02)
│   ├── Лист гарячекатаний (MG03)
│   │   └── path: MG01/MG02/MG03
│   ├── Лист холоднокатаний (MG04)
│   │   └── path: MG01/MG02/MG04
│   └── Лист нержавіючий (MG05)
│       └── path: MG01/MG02/MG05
├── Сортовий прокат (MG06)
│   ├── Круг (MG07)
│   │   └── path: MG01/MG06/MG07
│   ├── Квадрат (MG08)
│   │   └── path: MG01/MG06/MG08
│   └── Шестигранник (MG09)
│       └── path: MG01/MG06/MG09
├── Труби (MG10)
│   ├── Труба кругла (MG11)
│   │   └── path: MG01/MG10/MG11
│   └── Труба профільна (MG12)
│       └── path: MG01/MG10/MG12
└── Фасонний прокат (MG13)
    ├── Кутик (MG14)
    ├── Швелер (MG15)
    └── Двотавр (MG16)

КРІПЛЕННЯ (MG17)
├── Болти (MG18)
├── Гайки (MG19)
└── Шайби (MG20)
```

### SQL-запити для груп матеріалів:

```sql
-- Всі групи прокату з усіма нащадками
SELECT * FROM material_groups
WHERE path LIKE 'MG01%'
ORDER BY path;

-- Тільки листовий прокат (рівень 2 і нижче)
SELECT * FROM material_groups
WHERE path LIKE 'MG01/MG02%'
ORDER BY level;

-- Знайти батьківську групу
SELECT parent.* FROM material_groups parent
JOIN material_groups child ON child.parent_id = parent.id
WHERE child.id = 'MG03';
```

---

## 3. Структура виробу (items) - Кронштейн КР-150

```
Кронштейн КР-150 (I001) [assembly]
├── level: 0
├── path: I001
├── quantity: 1
│
├── Пластина основи (I002) [part]
│   ├── level: 1
│   ├── path: I001/I002
│   ├── position: 1
│   ├── quantity: 1
│   └── material: Лист г/к 4мм
│
├── Ребро жорсткості (I003) [part]
│   ├── level: 1
│   ├── path: I001/I003
│   ├── position: 2
│   ├── quantity: 4  ← 4 однакові деталі!
│   └── material: Лист г/к 3мм
│
├── Втулка (I004) [part]
│   ├── level: 1
│   ├── path: I001/I004
│   ├── position: 3
│   ├── quantity: 2
│   └── material: Круг 20мм
│
├── Болт М10×30 (I005) [standard]
│   ├── level: 1
│   ├── path: I001/I005
│   ├── position: 4
│   └── quantity: 4
│
├── Гайка М10 (I006) [standard]
│   ├── level: 1
│   ├── path: I001/I006
│   ├── position: 5
│   └── quantity: 4
│
└── Шайба 10 (I007) [standard]
    ├── level: 1
    ├── path: I001/I007
    ├── position: 6
    └── quantity: 8
```

### Маршрути виготовлення:

```
I002 (Пластина) → 005.Гільйотина → 010.Слюсарна → 025.Свердління
I003 (Ребро)    → 005.Гільйотина → 010.Слюсарна
I004 (Втулка)   → 005.Відрізна → 015.Токарна → 025.Свердління
I001 (Виріб)    → 035.Зварювання → 010.Слюсарна → 060.Контроль
```

### SQL-запити для структури виробу:

```sql
-- Повна структура виробу (специфікація)
SELECT
    REPEAT('  ', level) || position_number || '. ' || name as "Позиція",
    designation as "Позначення",
    item_type as "Тип",
    quantity as "Кільк."
FROM items
WHERE project_id = 'PRJ001'
ORDER BY path, sort_order;

-- Тільки деталі для виготовлення
SELECT * FROM items
WHERE project_id = 'PRJ001'
  AND item_type = 'part';

-- Тільки покупні
SELECT * FROM items
WHERE project_id = 'PRJ001'
  AND item_type IN ('standard', 'purchased');

-- Підрахунок матеріалів
SELECT
    m.name as "Матеріал",
    SUM(i.calculated_weight * i.quantity) as "Загальна вага"
FROM items i
JOIN materials m ON i.material_id = m.id
WHERE i.project_id = 'PRJ001'
GROUP BY m.name;
```

---

## 4. Перевірка цілісності дерев

### Правила валідації:

```sql
-- 1. Перевірка: parent_id не посилається на неіснуючий запис
SELECT child.* FROM departments child
LEFT JOIN departments parent ON child.parent_id = parent.id
WHERE child.parent_id IS NOT NULL AND parent.id IS NULL;
-- Має повернути 0 рядків

-- 2. Перевірка: level відповідає глибині в path
SELECT * FROM departments
WHERE level != (LENGTH(path) - LENGTH(REPLACE(path, '/', '')));
-- Має повернути 0 рядків

-- 3. Перевірка: немає циклічних посилань
WITH RECURSIVE tree AS (
    SELECT id, parent_id, 1 as depth FROM departments WHERE parent_id IS NULL
    UNION ALL
    SELECT d.id, d.parent_id, t.depth + 1
    FROM departments d
    JOIN tree t ON d.parent_id = t.id
    WHERE t.depth < 100
)
SELECT * FROM tree WHERE depth >= 100;
-- Має повернути 0 рядків (немає нескінченних циклів)

-- 4. Перевірка: path містить id батька
SELECT * FROM departments
WHERE parent_id IS NOT NULL
  AND path NOT LIKE '%' || parent_id || '/' || id;
-- Має повернути 0 рядків
```

---

## 5. Складний приклад: вкладена структура виробу

```
Верстат токарний ВТ-500 (PRJ002)
├── Станина (level 1) [assembly]
│   ├── Основа станини (level 2) [part]
│   ├── Напрямні (level 2) [part]
│   └── Кріплення (level 2) [assembly]
│       ├── Болт М16 (level 3) [standard]
│       └── Шайба 16 (level 3) [standard]
├── Шпиндельна бабка (level 1) [assembly]
│   ├── Корпус (level 2) [part]
│   ├── Шпиндель (level 2) [part]
│   └── Підшипники (level 2) [purchased]
├── Супорт (level 1) [assembly]
│   ├── Каретка (level 2) [part]
│   ├── Різцетримач (level 2) [assembly]
│   │   ├── Корпус різцетримача (level 3) [part]
│   │   └── Болти кріплення (level 3) [standard]
│   └── Механізм подачі (level 2) [assembly]
│       ├── Вал подачі (level 3) [part]
│       └── Шестерні (level 3) [purchased]
└── Електрообладнання (level 1) [assembly]
    ├── Двигун (level 2) [purchased]
    └── Пульт керування (level 2) [assembly]
        ├── Корпус пульта (level 3) [part]
        └── Кнопки (level 3) [purchased]
```

### Шляхи (path) для цієї структури:

| ID | Назва | Level | Path |
|----|-------|-------|------|
| V001 | Верстат ВТ-500 | 0 | V001 |
| V002 | Станина | 1 | V001/V002 |
| V003 | Основа станини | 2 | V001/V002/V003 |
| V004 | Напрямні | 2 | V001/V002/V004 |
| V005 | Кріплення | 2 | V001/V002/V005 |
| V006 | Болт М16 | 3 | V001/V002/V005/V006 |
| V007 | Шайба 16 | 3 | V001/V002/V005/V007 |
| V008 | Шпиндельна бабка | 1 | V001/V008 |
| ... | ... | ... | ... |

---

## 6. Переваги структури з path

### Швидкий пошук нащадків:
```sql
-- Знайти ВСІ компоненти вузла "Супорт" (будь-якої глибини)
SELECT * FROM items WHERE path LIKE 'V001/V010%';
```

### Швидке визначення рівня:
```sql
-- Рівень = кількість "/" в path
SELECT *, (LENGTH(path) - LENGTH(REPLACE(path, '/', ''))) as calculated_level
FROM items;
```

### Побудова "хлібних крихт":
```sql
-- Для позиції V006 (Болт М16): Верстат → Станина → Кріплення → Болт М16
SELECT * FROM items
WHERE 'V001/V002/V005/V006' LIKE path || '%'
ORDER BY level;
```

---

## Висновок

Всі ієрархічні структури в системі побудовані за єдиним принципом:

1. **parent_id** - посилання на батьківський запис
2. **level** - рівень вкладеності (0 = корінь)
3. **path** - повний шлях від кореня через "/"
4. **sort_order** - порядок сортування на одному рівні

Ця структура забезпечує:
- ✅ Швидкий пошук всіх нащадків
- ✅ Швидке визначення глибини
- ✅ Легку побудову навігації
- ✅ Можливість необмеженої вкладеності
- ✅ Збереження порядку сортування
- ✅ Просту валідацію цілісності
